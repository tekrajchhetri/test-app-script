name: Sheets Sync

on:
  workflow_dispatch:
    inputs:
      sheet_name:        { required: false, default: "" }
      spreadsheet_id:    { required: false, default: "" }
      spreadsheet_name:  { required: false, default: "" }
      change_type:       { required: false, default: "" }
      edited_a1:         { required: false, default: "" }
      actor_email:       { required: false, default: "" }
      source:            { required: false, default: "google-sheets" }

jobs:
  run-with-python:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      # 🔐 Write service account key from secret
      - name: Write service account key to file
        run: |
          cat > sa_key.json <<'JSON'
          ${{ secrets.GCP_SA_KEY }}
          JSON

      - name: Validate key JSON
        run: |
          python - <<'PY'
          import json
          json.load(open('sa_key.json','r',encoding='utf-8'))
          print("✅ sa_key.json is valid JSON")
          PY

      - name: Process Google Sheet → CSV + NDJSON
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}   # optional; enables mapping if set
        run: |
          # Fallbacks if manual dispatch inputs are left blank
          SHEET_ID="${{ github.event.inputs.spreadsheet_id }}"
          SHEET_NAME="${{ github.event.inputs.sheet_name }}"
          : "${SHEET_ID:=${{ secrets.SHEET_ID }}}"          # fallback to secret SHEET_ID if provided
          : "${SHEET_NAME:=Form Responses}"                 # default tab name

          python scripts/process_sheet_and_save.py \
            --spreadsheet-id "${SHEET_ID}" \
            --sheet-name "${SHEET_NAME}" \
            --csv-out data/sheets/output_normalized.csv \
            --json-out data/sheets/output_kg.jsonl \
            --sa-key-file sa_key.json
            # Mapping is ON by default; to disable add: --no-llm-mapping
            # To choose a specific model add: --openrouter-model openai/gpt-4o-mini

      - name: Verify outputs exist
        run: |
          test -f "data/sheets/output_normalized.csv" || (echo " CSV missing" && exit 1)
          test -f "data/sheets/output_kg.jsonl" || (echo " NDJSON missing" && exit 1)
          echo " Outputs present"

      - name: Commit generated files
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          git add data/sheets/output_normalized.csv data/sheets/output_kg.jsonl
          if ! git diff --cached --quiet; then
            git commit -m "chore: update from Google Sheets → CSV (mapped) + NDJSON (KG)"
            git push
          else
            echo "No changes to commit."
          fi
